/*		d m a k e f i l e
 * File:
  	dmakefile
 * Function:
  	Drama makefile source for 2DFCANTASK sub system
  
 * Description:
  	The program dmkmf should be run in the directory containing this
  	file to generate a Makefile or descrip.mms file for the desired
  	target

  
 * Author: {author}
 
 *  Copyright (c) Anglo-Australian Telescope Board, 2018.
    Not to be used for commercial purposes without AATB permission.
  

 * "@(#) $Id: ACMM:2dFCanTask/dmakefile,v 1.6 23-Aug-2021 10:48:18+10 tjf $"

 * History:
     02-Mar-2018 - KS  - Original version
     23-Aug-2021 - TJF - Rework for all components being installed correctly.
                          The rework brought this up to the spec used in HectorRotator
                          and presumes the libraries were installed - say via the
                          the AAO_CANopen_System system.

     23-Aug-2021 - TJF - System name changed from 2dFCanTask to tdFCanTask since
                          we can't release with a number as the first charater.
	
			
 */
 
#BeginConfig 
ACMM_RELEASE=1_7$(ACMMBUILDVER)
RELEASE=r$(ACMM_RELEASE)
SYSTEM=tdFCanTask			/* System name (for release	*/

/* This should in the drama_local.cf file. Note that there are also includes in /usr/local/include.  See CanInterfacesAAO, README.txt for more details */
/*ANAGATE_LIBS=/usr/local/lib/libCANDLLStaticRelease64.a /usr/local/lib/libAnaGateStaticRelease-1.0.9.a /usr/local/lib/libAPIStaticRelease64.a /usr/local/lib/libAnaGateExtStaticRelease-1.0.3.a*/

/*
 * Includes and libraries used for can open and simulator
 */

CAN_INCLUDES = IDir(GENINSSTSIM_DIR) IDir(SIMCANOPEN_DIR) IDir(CANBUSINICONFIG_DIR) IDir(XWING_DIR) \
   IDir(CANBUSINICONFIG_DIR) IDir(TCSUTIL_DIR) IDir(SIMSERIALLINE_DIR) $(CML_INCLUDE) \
   IDir(CANINTERFACESAAO_DIR)


CAN_LIBRARIES =LinkLibDir(GENINSSTSIM_LIB,GenInstSimulator) LinkLibDir(SIMCANOPEN_LIB,SimCanOpen) \
    LinkLibDir(CANBUSINICONFIG_LIB,AAOCANBusConfigurator) LinkLibDir(XWING_LIB,XWing) \
    LinkLibDir(SIMSERIALLINE_LIB,SimSerialLine) LinkLibDir(TCSUTIL_LIB,TcsUtil)  \
    LinkLibDir(CANINTERFACESAAO_LIB,CanInterfacesAAO) $(ANAGATE_LIBS) $(CML_LIB) \
    -pthread

/*
BOOST_DIR=/instsoft/extern/boost/
BOOST_INCL=-I$(BOOST_DIR)/include
BOOST_LIB=-L$(BOOST_DIR)/lib -lboost_thread -lboost_system
*/

/*
CONFIGURATOR_DIR = ../AAOCANBusIniConfigurator
CML_DIR = ../CANopen_CML
SIM_CAN_OPEN_DIR = ../SimCanOpen
XWING_DIR = ../XWing
TCS_UTIL_DIR = ../TcsUtil
*/
INCLUDES =  -I. DramaIncl IDir(DRAMA2_DIR) $(CAN_INCLUDES) IDir(GCAM_DIR) IDir(GCAM2_DIR) $(SLA_INCL) -I$(VIMBASDK_DIR)

USERCCOPTIONS = AnsiCFull()  /* Enable Full Ansi C           */
/*
 * Enable Ansi C++ V11/V14 full warnings.  If we have C++14, then we
 * use it, otherwise we presume we have C++11
 */
#if HasCPlusPlus14
USERCCCOPTIONS = AnsiCC14Full()
#else
USERCCCOPTIONS = AnsiCC11Full()
#endif

/*
 * -no-pie is needed to link against the Anagate libraries.  We presume
 * for the moment that this is on 64 bit machines only since it does not
 * work on aaolxp 32 bit builds.  On aaolxp we also need -lrd
 */
#ifdef LinuxArchitecture
#if defined(X86_64Architecture)
LOCAL_LDFLAGS=-no-pie
#elif defined(X86Architecture)
LOCAL_LDFLAGS=-lrt
#endif
#endif




#EndConfig
LIBS=LinkLib(TdFCanTask)  LinkLibDir(DRAMA2_LIB,drama2) $(CAN_LIBRARIES) -L$(VIMBASDK_LIBS) LinkLibDir(GCAM2_LIB,gcam2) LinkLibDir(GCAM_LIB,gcam)  $(SLA_LIB) $(FITS_LIB) -lboost_filesystem
GRIP_LIBS=LinkLib(TdFGripperTask)  LinkLibDir(DRAMA2_LIB,drama2) $(CAN_LIBRARIES) -L$(VIMBASDK_LIBS) LinkLibDir(GCAM2_LIB,gcam2) LinkLibDir(GCAM_LIB,gcam)  $(SLA_LIB) $(FITS_LIB) -lboost_filesystem

NormalCRules()			/* Include normal c rules	*/


/* List of files which make up the library.  GNU Make macros
 * in the definition of OBJECTS and SRC1 convert these names
 * to .o and .cpp files respectively.
 */

OBJECTS_BASE=CanAccess TdFCanTask_$(RELEASE) 

GIRPPER_OBJECTS_BASE=CanAccess TdFGripperTask_$(RELEASE)

/*
 *	Objects to be put in the 2DFCANTASK library.
 */
OBJECTS =  $(addsuffix .o,$(OBJECTS_BASE)) 

GRIPPER_OBJECTS =  $(addsuffix .o,$(GIRPPER_OBJECTS_BASE)) 
/*
 *	Sources for makedepend.  
 *
 * We need to add 2dFCanTask.cpp to those from OBJECTS_BASE.
 */

SRC1=   $(addsuffix .cpp,$(OBJECTS_BASE))  TdFCanTaskVersion.c TdFCanTask.cpp 

SRC2=  $(addsuffix .cpp,$(GIRPPER_OBJECTS_BASE)) TdFGripperTaskVersion.c TdFGripperTask.cpp
/*
 * The target All will build the 2DFCANTASK library and program.
 */

DummyTarget(All,  NotVms(checktarget) CML_LIB_CHECK includes Lib(TdFCanTask) Exe(TdFCanTask))
DummyTarget(All,  NotVms(checktarget) CML_LIB_CHECK includes Lib(TdFGripperTask) Exe(TdFGripperTask))
DramaCheckTarget()

/*
 * Warn if we can''t find the CML library in the standard location.
 *   Normally $DRAMA/drama_local.cfg should set CML_INCLUDE and CML_LIBS correctly.
 *    If it does that, it will also define HasCML.
 *   For historical reasons, we allow the build to continue if this is not the case
 *    presuming the library is available in an adjoining directory.
 */
.PHONY : CML_LIB_CHECK
#ifdef HasCML
CML_LIB_CHECK :
#else
CML_INCLUDE=-I ../CANopen_CML/inc -I ../CANopen_CML/inc/can
CML_LIB=../CANopen_CML/c/libcml.a
CML_LIB_CHECK :
	@echo ""
	@echo "*** CML library not properly enabled on this machine in $$DRAMA_LOCAL/drama_local.cfg, looking for it  in ../CANopen_CML ***"
	@echo ""
#endif
release :: CML_LIB_CHECK



/*
 * We use an includes target for include files which need to be built.  This
 * is only really necessary if makedepnds has not been run.
 */

DummyTarget(includes, TdFCanTask.h TdFCanTask_err.h TdFCanTask_err_msgt.h )
DummyTarget(includes, TdFGripperTask.h TdFGripperTask_err.h TdFGripperTask_err_msgt.h)
/*
* Generate the error code include file.
*/

ErrorIncludeFiles(TdFCanTask_err)
ErrorIncludeFiles(TdFGripperTask_err)


TdFCanTask_$(RELEASE).o : TdFCanTaskVersion.c
	@ echo Compiling TdFCanTaskVersion to $@
	$(CC) -c $(CFLAGS) StringDefine(TDFCANTASK_VER,$(RELEASE)) -DTDFCANTASK_DATE=$(DATE_CMD) TdFCanTaskVersion.c 
	mv TdFCanTaskVersion.o $@

TdFGripperTask_$(RELEASE).o : TdFGripperTaskVersion.c
	@ echo Compiling TdFGripperTaskVersion to $@
	$(CC) -c $(CFLAGS) StringDefine(TDFGRIPPERTASK_VER,$(RELEASE)) -DTDFGRIPPERTASK_DATE=$(DATE_CMD) TdFGripperTaskVersion.c 
	mv TdFGripperTaskVersion.o $@

CanAccess.o : CanAccess.cpp CanAccess.h

/*
 * The 2DFCANTASK object library
 */

ObjectLibraryTarget(TdFCanTask, $(OBJECTS),)
ObjectLibraryTarget(TdFGripperTask, $(GRIPPER_OBJECTS),)

/*
 * The 2DFCANTASK program itself
 */

DramaCPPProgramTarget(TdFCanTask, Obj(TdFCanTask), Lib(TdFCanTask), $(LIBS),)
DramaCPPProgramTarget(TdFGripperTask, Obj(TdFGripperTask), Lib(TdFGripperTask), $(GRIP_LIBS),)

/*
 * Release targets
 */
DramaReleaseCheck()
DramaReleaseCommon(TdFCanTask.h TdFCanTask_err.h TdFCanTask_err_msgt.h CanAccess.h TdFGripperTask.h TdFGripperTask_err.h TdFGripperTask_err_msgt.h)
DramaReleaseTarget(TdFCanTask TdFGripperTask, Lib(TdFCanTask) Lib(TdFGripperTask),,)
DramaReleaseDramaStart()

/*
 * Target to enableGIT.
 */
DramaEnable()
DramaDirs()

